generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
}

model User {
  id           Int        @id @default(autoincrement())
  name         String
  email        String
  passwordHash String      @map("password_hash")
  role         Role        @default(USER)
  createdAt    DateTime    @default(now()) @map("created_at")

  orders       Order[]
  payments     Payment[]
  reviews      Review[]

  @@map("users")
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String      @unique
  description String?
  createdAt   DateTime    @default(now()) @map("created_at")

  tours       Tour[]

  @@map("categories")
}

model Tour {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  basePrice   Decimal      @map("base_price") @db.Decimal(12, 2)
  discount    Decimal?     @map("discound")   @db.Decimal(12, 2)
  createdAt   DateTime     @default(now()) @map("created_at")

  categoryId  Int?         @map("category_id")
  category    Category?    @relation(fields: [categoryId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  images      TourImage[]
  departures  TourDeparture[]
  reviews     Review[]

  @@map("tours")
}

model TourImage {
  id       Int       @id @default(autoincrement())
  url      String
  position Int        @default(0)

  tourId   Int        @map("tour_id")
  tour     Tour       @relation(fields: [tourId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@map("tour_images")
}

model TourDeparture {
  id               Int        @id @default(autoincrement())
  departure        DateTime    @map("departure_datetime")
  price            Decimal     @db.Decimal(12, 2)
  capacity         Int
  availableSeats   Int         @map("available_seats")

  tourId           Int         @map("tour_id")
  tour             Tour        @relation(fields: [tourId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  items            OrderItem[]

  @@map("tour_departures")
}

model Order {
  id          Int           @id @default(autoincrement())
  status      OrderStatus    @default(PENDING)
  totalAmount Decimal        @default(0) @map("total_amount") @db.Decimal(12, 2)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime?      @default(now()) @updatedAt @map("updated_at")

  userId      Int            @map("user_id")
  user        User           @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Restrict)

  items       OrderItem[]
  payments    Payment[]

  @@map("orders")
}

model OrderItem {
  id              Int       @id @default(autoincrement())
  quantity        Int
  unitPrice       Decimal    @map("unit_price") @db.Decimal(12, 2)
  totalPrice      Decimal    @map("total_price") @db.Decimal(12, 2)

  orderId         Int        @map("order_id")
  order           Order      @relation(fields: [orderId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  tourDepartureId Int        @map("tour_departure_id")
  departure       TourDeparture @relation(fields: [tourDepartureId], references: [id], onUpdate: Cascade, onDelete: Restrict)

  @@map("order_items")
}

model Payment {
  id        Int            @id @default(autoincrement())
  amount    Decimal        @db.Decimal(12, 2)
  status    PaymentStatus
  method    PaymentMethod
  createdAt DateTime        @default(now()) @map("created_at")

  orderId   Int             @map("order_id")
  order     Order           @relation(fields: [orderId], references: [id], onUpdate: Cascade, onDelete: Restrict)

  userId    Int             @map("user_id")
  user      User            @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Restrict)

  @@map("payments")
}

model Review {
  id        Int       @id @default(autoincrement())
  rating    Int
  comment   String?
  createdAt DateTime   @default(now()) @map("created_at")

  tourId    Int        @map("tour_id")
  tour      Tour       @relation(fields: [tourId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  userId    Int        @map("user_id")
  user      User       @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@map("reviews")
}
