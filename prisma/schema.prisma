generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  TOUR_MANAGER
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
}

enum PromoType {
  NEW
  ALL
}


model User {
  id           Int        @id @default(autoincrement())
  name         String
  email        String      @unique
  passwordHash String      
  role         Role        @default(USER)
  createdAt    DateTime    @default(now())

  orders       Order[]
  payments     Payment[]
  reviews      Review[]
  promotionUsages PromotionUsage[]
  favorites   TourFavorited[]
  toursCreated Tour[]
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String      @unique
  description String?
  createdAt   DateTime    @default(now())

  tours       Tour[]
}

model Tour {
  id          Int         @id @default(autoincrement())
  name        String
  description String      @db.LongText
  address     String
  information String       @db.LongText
  basePrice   Decimal      @db.Decimal(12, 2)
  discount    Decimal?     @db.Decimal(12, 2)
  createdAt   DateTime     @default(now())

  createdBy   Int
  creator     User         @relation(fields: [createdBy], references: [id], onUpdate: Cascade, onDelete: Restrict)


  categoryId  Int?        
  category    Category?    @relation(fields: [categoryId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  locationId  Int?        
  location    Location?    @relation(fields: [locationId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  images      TourImage[]
  departures  TourDeparture[]
  reviews     Review[]
  favorites   TourFavorited[]
}

model TourImage {
  id       Int       @id @default(autoincrement())
  url      String
  position Int        @default(0)

  tourId   Int       
  tour     Tour       @relation(fields: [tourId], references: [id], onUpdate: Cascade, onDelete: Cascade)

}

model TourDeparture {
  id               Int        @id @default(autoincrement())
  departure        DateTime 
  price            Decimal     @db.Decimal(12, 2)
  capacity         Int
  availableSeats   Int        

  tourId           Int         
  tour             Tour        @relation(fields: [tourId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  items            OrderItem[]

}

model Order {
  id          Int           @id @default(autoincrement())
  status      OrderStatus    @default(PENDING)
  totalAmount Decimal        @default(0) @db.Decimal(12, 2)
  createdAt   DateTime       @default(now()) 
  updatedAt   DateTime       @updatedAt 

  userId      Int
  user        User           @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Restrict)

  items       OrderItem[]
  payments    Payment[]

}

model OrderItem {
  id              Int       @id @default(autoincrement())
  quantity        Int
  unitPrice       Decimal    @db.Decimal(12, 2)

  orderId         Int        
  order           Order      @relation(fields: [orderId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  tourDepartureId Int       
  departure       TourDeparture @relation(fields: [tourDepartureId], references: [id], onUpdate: Cascade, onDelete: Restrict)

}

model Payment {
  id        Int            @id @default(autoincrement())
  amount    Decimal        @db.Decimal(12, 2)
  status    PaymentStatus
  method    PaymentMethod
  createdAt DateTime        @default(now()) 

  orderId   Int
  order     Order           @relation(fields: [orderId], references: [id], onUpdate: Cascade, onDelete: Restrict)

  userId    Int
  user      User            @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Restrict)
}

model Review {
  id        Int       @id @default(autoincrement())
  rating    Int
  comment   String?
  createdAt DateTime   @default(now()) 

  tourId    Int        
  tour      Tour       @relation(fields: [tourId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  userId    Int
  user      User       @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
}

model Promotion {
  id          Int       @id @default(autoincrement())
  discount    Int       
  amount      Int
  code        String    @unique @db.VarChar(20)
  type        PromoType
  name        String    @db.VarChar(30)
  description String    @db.Text
  startAt     DateTime  @default(now())
  endAt       DateTime? @db.Timestamp(6)

  promotionUsages PromotionUsage[]
}

model PromotionUsage {
  id           Int        @id @default(autoincrement())
  userId       Int
  promotionId  Int
  user       User        @relation(fields: [userId], references: [id])
  promotion  Promotion    @relation(fields: [promotionId], references: [id])

  @@unique([userId, promotionId])
}

model Location {
  id    Int    @id @default(autoincrement())
  name  String @db.VarChar(50)

  tours Tour[]
}

model TourFavorited {
  id        Int      @id @default(autoincrement())
  userId    Int
  tourId    Int

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tour      Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@unique([userId, tourId])
}
